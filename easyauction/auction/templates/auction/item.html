{% extends 'auction/base2.html' %}

{% block title %}{{item.name}}{% endblock %}

{% block content %}
    <div style="align-self: start">
        <v-btn href="{% url 'auction:auction_detail' item.auction.id %}">
            <v-icon>mdi-chevron-left</v-icon>
            Back to Auction
        </v-btn>
    </div>
    <v-form id="edit_item_form" action="{% url "auction:edit_item" item.id %}" method="POST">{% csrf_token %}</v-form>
    <form id="bid_form" action="{% url "auction:submit_bid" item.id %}" method="POST">{% csrf_token %}</form>

    <v-card class="d-inline-block mx-auto">
        <v-container>
            <v-row>
                {# Displays item image #}
                <v-col cols="auto">
                    <v-img
                        max_height="200"
                        max_width="200"
                        src="{{ item.image.url }}"
                    ></v-img>
                </v-col>
                <v-col class="text-center">

                    {# If the user is the admin then display an edit button #}
                    {% if admin %}
                    <v-layout v-show="!edit" justify-end>
                        <v-btn icon @click="edit =!edit" >
                            <v-icon color="blue">mdi-pencil</v-icon>
                        </v-btn>
                    </v-layout>
                    <v-layout v-show="edit" justify-end>
                        <v-btn color="blue" :disabled="!isParticipant" icon type="submit" form="edit_item_form" >
                            <v-icon>mdi-check</v-icon>
                        </v-btn>
                    </v-layout>
                    {% endif %}


                    {# Displays if item is sold #}
                    {% if item.is_sold %}
                        <p style="color:red; font-size: 20px"><strong>SOLD!</strong></p>
                    {% elif item.bid_set.last.bidder == user %}
                        <p style="color:green; font-size: 15px"><strong>You are currently winning!</strong></p>
                    {% endif %}


                    {# Displays item name #}
                    <v-text-field
                        form="edit_item_form" name="name"
                        label="Item Name" value="{{ item.name }}"
                        :readonly="!edit"
                    ></v-text-field>


                    {# Displays current price / winning price / starting price #}
                    {% if item.auction_type == "silent" %}
                        <v-text-field
                            {% if item.is_sold %}
                                label="Final Bid"
                            {% elif item.bid_set.count > 0 %}
                                label="Current Bid"
                            {% else %}
                                label="Starting Price"
                            {% endif %}
                            prefix="$" value="{{ item.current_price }}"
                            type="number" step=".01" readonly v-show="!edit"
                        ></v-text-field>
                        {% if item.bid_set.count == 0 %}
                            <v-text-field
                                form="edit_item_form" name="starting_price"
                                label="Edit Starting Price"
                                prefix="$" value="{{ item.starting_price }}"
                                type="number" step=".01" v-show="edit"
                            ></v-text-field>
                        {% endif %}
                    {% else %}
                        <v-text-field
                            form="edit_item_form" name="starting_price" label="Starting Bid"
                            prefix="$" value="{{ item.starting_price }}" type="number"
                            step=".01" :readonly="!edit"
                        ></v-text-field>
                    {% endif %}


                    {# Displays the minimum bid increment #}
                    {% if item.auction_type == "silent" %}
                        <v-text-field
                            form="edit_item_form" name="bid_increment" label="Minimum Bid Increment"
                            prefix="$" value="{{ item.bid_increment }}" type="number"
                            step=".01" v-show="edit"
                        ></v-text-field>
                    {% endif %}


                    {# Text input for user to bid or timer display for when item opens #}
                    {% if item.auction_type == "silent" %}
                        {% if not item.is_sold %} {# !!! USE '... and if item.is_open' for Production !!! #}
                            <v-text-field
                                v-model="bid_amount" form="bid_form"
                                name="bid" label="Enter Bid" prefix="$"
                                type="number" step=".01" :rules="[rules.amount]"
                                v-show="!edit"
                            ></v-text-field>
                            <v-btn
                                :disabled="!isCorrectAmt" :rules="[rules.amount]"
                                form="bid_form" type="submit" form="bid_form" v-show="!edit"
                            >
                            Place Bid
                            </v-btn>
                        {% elif not item.is_sold %}
                            {# TODO: implement timer for items #}
                            Open for bidding in 'hh:mm:ss' ('start_time')
                        {% endif %}
                    {% endif %}


                    {# Displays the number of bids #}
                    {% if item.auction_type == 'silent' %}    {# !!! USE '... and if item.is_open' for Production !!! #}
                        <span>{{ item.bid_set.count }} [[{{ item.bid_set.count }} == 1 ? 'Bid' : 'Bids']]</span>
                    {% endif %}


                    {% comment %}
                    If there is a winner, then show everyone the winner and price paid; otherwise, don't show that
                    info. The admin can add/edit the winner and price paid when in edit mode.
                    {% endcomment %}
                    {% if item.auction_type == 'silent' %}
                        {% if item.winner %}
                            <v-text-field
                                label="Winner" readonly
                                value="{{ item.winner.username }}"
                            ></v-text-field>
                        {% endif %}
                    {% else %}
                        {% if item.winner %}
                            <v-text-field
                                form="edit_item_form" name="current_price" label="Final Bid"
                                prefix="$" value="{{ item.current_price }}" type="number"
                                step=".01" :readonly="!edit"
                            ></v-text-field>
                            <v-text-field
                                v-show="!edit" readonly
                                label="Winner" value="{{ item.winner.username }}"
                            ></v-text-field>
                        {% else %}
                            <v-text-field
                                form="edit_item_form" name="current_price" label="Final Bid"
                                prefix="$" value="{{ item.current_price }}" type="number"
                                step=".01" v-show="edit"
                            ></v-text-field>
                        {% endif %}
                        <v-combobox
                            v-show="edit" v-model="selected_winner"
                            :items="participants" label="Select Winner"
                            form="edit_item_form" name="winner" :rules="[rules.winner]"
                            :search-input.sync="winner_search"
                        ></v-combobox>
                    {% endif %}
                </v-col>
            </v-row>


            {# Drop down buttons for description and bid history #}
            <v-card-actions style="justify-content: space-around">
                <v-btn text @click="show_desc = !show_desc">
                    <v-icon>[[ show_desc ? 'mdi-chevron-up' : 'mdi-chevron-down' ]]</v-icon>
                    Description
                </v-btn>
                {% if item.auction_type == 'silent' %}
                    <v-btn text @click="show_bids = !show_bids">
                        <v-icon>[[ show_bids ? 'mdi-chevron-up' : 'mdi-chevron-down' ]]</v-icon>
                        Bid History
                    </v-btn>
                {% endif %}
            </v-card-actions>

            {# Displays description when drop down is clicked #}
            <v-expand-transition>
                <div v-show="show_desc">
                    <v-textarea
                        form="edit_item_form" name="description"
                        label="Item Description" value="{{ item.description }}"
                        :readonly="!edit" filled
                    ></v-textarea>
                </div>
            </v-expand-transition>


            {# Displays bids when drop down is clicked #}
            {% if item.auction_type == 'silent' %}
                <v-expand-transition>
                    <div v-show="show_bids" class="text-center">
                        {% if item.bid_set.count > 0 and admin %}
                        <v-btn small outlined color="red"
                               href="{% url 'auction:remove_bid' item.id item.bid_set.first.id %}">
                            <v-icon color="red" small>delete</v-icon>
                            Delete latest bid
                        </v-btn>
                        {% endif %}
                        <v-data-table
                            :headers="headers"
                            :items="bids"
                            :items-per-page="5"
                        >
                        </v-data-table>
                    </div>
                </v-expand-transition>
            {% endif %}
        </v-container>
    </v-card>
{% endblock %}

{% block vue %}
    <script>
    /** Used for checking if users bid amount is enough **/
    min_bid_amount = {{ item.min_bid }};

    /** Used for showing bid history **/
    bid_objects = [];
    {% for b in item.bid_set.all %}
        bid_objects.push({bidder: '{{ b.bidder }}', amount: '$ {{ b.price }}', time: '{{ b.timestamp }}' });
    {% endfor %}
    bid_objects.reverse();

    /** Lists participants for admin to choose winner of live item**/
    participants = [];
    {% for p in item.auction.participants.all %}
        participants.push('{{ p.username }}');
    {% endfor %}

    Vue.use(Vuetify);
    assorted_vue = new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        data: {
            drawer: false,
            show_desc: false,
            show_bids: false,
            edit: false,
            bid_amount: null,
            rules: {
                amount: function(value) {
                    if (value < min_bid_amount)
                        return 'Bid Minimum: $' + min_bid_amount.toFixed(2).toString()
                    else return true
                },
                winner: function(username) {
                    if (!participants.includes(username) && username != null && username !== "")
                        return username + " is not a participant";
                    else return true
                }
            },
            headers: [
                {text: "Bidder", value: "bidder", align: 'left'},
                {text: "Bid Amount", value: "amount"},
                {text: "Bid Time", value: "time"}
            ],
            bids: bid_objects,
            selected_winner: "{{ item.winner.username }}",
            winner_search: null,
            participants: participants
        },
        computed: {
            isCorrectAmt: function () {
                return this.bid_amount >= min_bid_amount;
            },
            isParticipant: function () {
                return participants.includes(this.winner_search) || this.winner_search == null || this.winner_search === "";
            }
        },
        delimiters: ["[[", "]]"]
    });

    </script>
{% endblock %}
